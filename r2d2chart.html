<html>
    <head>
        <link rel="stylesheet" type="text/css" href="styles.css"/>
        <title>R2D2 charts</title>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script language="Javascript">
            google.charts.load('current', {'packages':['corechart', 'timeline']});
            google.charts.setOnLoadCallback(onLoad);

            var seeingData = {};

            function onLoad() {
                console.log("The page has loaded....");
                timerID = setInterval(clockTicker, 1000);
                getNewData('86400');
            } 

            function decimalPlacesFloat(value, places) {
            	multiplier = Math.pow(10, places);
	            return Math.round(value*multiplier) / multiplier;
            }

           function processData(err, textData) {
                var textData = textData.split('\n');
                seeingData['dates'] = [];
                seeingData['seeing_trans'] = [];
                seeingData['seeing_long'] = [];
                seeingData['star'] = [];
                seeingData['airmass'] = [];
                console.log("seeing data....contains " + textData.length + " rows.");
                if (err!=null) {
                    console.log("Error...");
                    console.log(err);
                    return;
                }
                for (var i in textData) {
                    fields = textData[i].split(",");
                    if (i==0) continue;
                    if (fields.length<2) continue;
                    seeingData['dates'].push(new Date(fields[0]));
                    seeingData['seeing_trans'].push(parseFloat(fields[1]));
                    seeingData['seeing_long'].push(parseFloat(fields[2]));
                    seeingData['star'].push(fields[3]);
                    seeingData['airmass'].push(parseFloat(fields[4]));
                }

                //for (var i in seeingData['dates']) {
                //    console.log(seeingData['dates'][i] + " : " + seeingData['seeing_trans'][i] + " " + seeingData['seeing_long'][i] + " " + seeingData['star'][i] + ' ' + seeingData['airmass'][i]);
                //}
                console.log("Data loaded, now calling 'drawChart'");
                document.getElementById('npoints').innerText = seeingData['dates'].length;
                if (seeingData['dates'].length) {
                    drawSeeingChart();
                    drawStarChart();
                    drawAirmassSeeingChart();
                    drawStatsChart();
                }
            }

            function drawStarChart() {
                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn({ type: 'string', id: 'Star' });
                dataTable.addColumn({ type: 'date', id: 'Start' });
                dataTable.addColumn({ type: 'date', id: 'End' });
    
                currentStar = "none";
                for (var i in seeingData['dates']) {
                    if (seeingData['star'][i] != currentStar) {
                        if (currentStar!="none") dataTable.addRow( [ currentStar, startTime, endTime ]);
                        currentStar = seeingData['star'][i];
                        startTime = seeingData['dates'][i];
                    }
                    endTime = seeingData['dates'][i];
                }
                dataTable.addRow( [ currentStar, startTime, endTime ]);
                var chart = new google.visualization.Timeline(document.getElementById('stars'));
                var options = {
                    animation: {startup: true, duration: 750, easing: 'out' } , 
                    backgroundColor: "#f5f4f0", 
                    chartArea: { 
                        backgroundColor: "#f5f4f0", 
                        width: 580,
                        }
                };
                chart.draw(dataTable, options);

            }

            function drawAirmassSeeingChart() {
                var data =  new google.visualization.DataTable();
                data.addColumn('number', 'airmass');
                data.addColumn('number', 'seeing');
                for (var i in seeingData['dates']) {
                    meanSeeing = (seeingData['seeing_trans'][i] + seeingData['seeing_long'][i]) / 2;
                    airmass = parseFloat(seeingData['airmass'][i]);
                    data.addRow([airmass, meanSeeing]);
                }
                var chart = new google.visualization.ScatterChart(document.getElementById('airmass'));
                var options = {
                    title: 'Airmass vs Seeing', 
                    hAxis: {title: 'airmass'},
                    vAxis: {title: 'seeing'},
                    backgroundColor: "#f5f4f0", 
                    series: {
                        0: { pointShape: 'square',
                        visibleInLegend: false },
                    },
                    dataOpacity: 0.4,
                    trendlines: {
                        0: {
                        type: 'linear',
                        color: 'blue',
                        lineWidth: 1,
                        opacity: 0.3,
                        visibleInLegend: false
                        }
                    }
                    
                }
                chart.draw(data, options);
            }

            function drawSeeingChart() {
                var data =  new google.visualization.DataTable();
                data.addColumn('date', 'Date');
                data.addColumn('number', 'Seeing Long');
                data.addColumn('number', 'Seeing Trans');
                for (var i in seeingData['dates']) {
                    data.addRow([seeingData['dates'][i], parseFloat(seeingData['seeing_trans'][i]), parseFloat(seeingData['seeing_long'][i])]);
                }
                
                var options = {
                    title: 'Seeing',
                    legend: { position: 'in' }, 
                    chartArea: { 
                        backgroundColor: "#f5f4f0", 
                        width: 600,
                        }, 
                    backgroundColor: "#f5f4f0", 
                    series: {
                        0: { pointShape: 'square' },
                        1: { pointShape: 'triangle' },
                    },
                    explorer: { 
                        actions: ['dragToZoom', 'rightClickToReset'],
                        maxZoomIn: 0.01 
                        },
                    trendlines: {
                        0: {
                        type: 'polynomial',
                        color: 'blue',
                        lineWidth: 1,
                        opacity: 0.3,
                        degree: 0,
                        },
                        1: {
                        type: 'polynomial',
                        color: 'red',
                        lineWidth: 1,
                        opacity: 0.3,
                        animation: {startup: true, duration: 750, easing: 'out' } , 
                             degree: 0,
                        }
                    }
                };

                var chart = new google.visualization.ScatterChart(document.getElementById('seeing'));
                
                chart.draw(data, options);
            }

            function drawStatsChart() {
                seeing = [];
                for (var i in seeingData['dates']) seeing.push((seeingData['seeing_trans'][i] + seeingData['seeing_long'][i])/2 );
                
                var n = seeing.length;
                var sum = 0;
                for (var i in seeing) sum = sum + seeing[i];
                var mean = sum/n;
                var variance = 0;
                for (var i in seeing) variance+= (seeing[i] - mean)**2;
                var std = Math.sqrt(variance/(n-1));
                console.log("Mean: " + mean);
                console.log("Std deviation: " + std);
                seeing.sort(function(a,b){ return a-b; });
                var midpoint = Math.floor(n / 2);
                if (n % 2) median = seeing[midpoint]; else var median = (seeing[midpoint - 1] + seeing[midpoint]) / 2.0;
                console.log("Median: " + median);

                data =  new google.visualization.DataTable();
                data.addColumn('number', 'Seeing');
                options = {
                    backgroundColor: "#f5f4f0", 
                    title: "median: " + decimalPlacesFloat(median, 2) + " mean: " + decimalPlacesFloat(mean, 2) + " stddev: " + decimalPlacesFloat(std, 2), 
                    hAxis: {title: 'seeing'},
                    vAxis: {title: 'N'},
                    legend: {position: 'none'},
                    histogram: { hideBucketItems: true }
                    };
                for (var i in seeing) data.addRow([seeing[i]]);
                chart = new google.visualization.Histogram(document.getElementById('stats'));
                chart.draw(data, options);

            }

            function getData(url, callback) {
                var xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    xhr.responseType = 'text';
                    xhr.onload = function() {
                        var status = xhr.status;
                        if (status === 200) {   
                            callback(null, xhr.response);
                        } else {
                            callback(status, xhr.response);
                        }
                    };   
                xhr.send();
            };

            function getNewData(seconds) {
                console.log("in get new data....");
                console.log("seconds to go back to..." + seconds);
                var now = new Date();
                console.log(now);
                var startDate = new Date(now - seconds * 1000);
                console.log(startDate);
                var params = "time_start=" + encodeURIComponent(formatUTCTime(startDate));
                console.log("Params: " + params);
                // params = "time_start=2018-12-11+20%3A00%3A00";
                getData('http://robodimm.ing.iac.es/robodimm/get_data.php?' + params, processData);
            }    

            function clockTicker() {
		    	var now = new Date();
			    document.getElementById('UTCfield').innerText = formatUTCTime(now);
            }

            function zeroPad(input) {
                if (input < 10) return "0" + input.toString();
                return input.toString();
            } 

    		function formatUTCTime(date) {
                var dateStr = date.getUTCFullYear() + "-" + zeroPad(date.getUTCMonth()+1) + "-" + zeroPad(date.getUTCDate());
                var time = zeroPad(date.getUTCHours()) + ":" + zeroPad(date.getUTCMinutes()) + ":" + zeroPad(date.getUTCSeconds());
                return dateStr + " " + time;
			}
  
	
            
           
</script>
</head>

<body>
    
    <img src="r2d2graphs.png">
        <div>
            Current date: <span id="UTCfield"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span id="npoints" style="font-weight: bold;">0</span> points in dataset.
        </div>
        <div class="button">
                <button onclick="getNewData('86400')">24hr</button>
                <button onclick="getNewData('43200')">12hr</button>
                <button onclick="getNewData('28800')">8hr</button>
                <button onclick="getNewData('14400')">4hr</button>
                <button onclick="getNewData('7200')">2hr</button>
        </div>
        <div class="button">
                <button onclick="getNewData('604800')">1 week</button>
                <button onclick="getNewData('2678400')">1 month</button>
                <button onclick="getNewData('16070400')">6 months</button>
                <button onclick="getNewData('31536000')">1 year</button>
        </div> 
    
    <div id="seeing" style="width: 750px; height: 500px; position: absolute; top: 180px; left: 40px;"></div>
    <div id="airmass" style="width: 500px; height: 500px;  position: absolute; top: 180px; left: 750px;"></div>
    <div id="stars" style="width: 720px; height: 300px; position: absolute; top: 630px; left: 0px;"></div>
    <div id="stats" style="width: 500px; height: 500px;  position: absolute; top: 610px; left: 750px;"></div>
    
</body>
</html>
