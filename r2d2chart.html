<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <!-- Latest compiled and minified CSS -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        
        <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
        <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
        <link rel="stylesheet" type="text/css" href="styles.css"/> 
        <title>R2D2 charts</title>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script language="Javascript">
            google.charts.load('current', {'packages':['corechart', 'timeline']});
            google.charts.setOnLoadCallback(onLoad);

            var seeingData = {};
            var startTime = null;
            var endTime = null;
            var refreshID = null;
            var liveData = 0;
            var dataRefreshSize = "7200";   // Data range for updates (in seconds)
            var latestReading = null;

            var allCharts = [];

            function onLoad() {
                console.log("The page has loaded....");
                if (localStorage.getItem("liveData") != null) {
                    liveData = localStorage.getItem("liveData");
                    console.log("Restored liveData to: "+ liveData);
                    if (liveData==1) {
                        $('#refresh').bootstrapToggle('on');
                        document.getElementById("liveDisplay").style.visibility = "visible";
                    }
                };
                if (localStorage.getItem("dataRefreshSize") != null) {
                    loadedDataRefreshSize = localStorage.getItem("dataRefreshSize");
                    console.log("Restored dataRefreshSize to: "+ loadedDataRefreshSize);
                    getNewData(loadedDataRefreshSize);
                } else getNewData(dataRefreshSize);

                
                tickerID = setInterval(clockTicker, 1000);
            } 

            function decimalPlacesFloat(value, places) {
            	multiplier = Math.pow(10, places);
	            return Math.round(value*multiplier) / multiplier;
            }

           function processData(err, textData) {
                var textData = textData.split('\n');
                seeingData['dates'] = [];
                seeingData['seeing_trans'] = [];
                seeingData['seeing_long'] = [];
                seeingData['star'] = [];
                seeingData['airmass'] = [];
                console.log("get_data.php returned " + textData.length + " rows.");
                if (err!=null) {
                    console.log("Error...");
                    console.log(err);
                    return;
                }
                for (var i in textData) {
                    if (textData[i][0] == '#') continue;  // Skip lines containing comments
                    fields = textData[i].split(",");     
                    if (fields.length<2) continue;        // Skip the blank lines
                    seeingData['dates'].push(new Date(fields[0]));
                    seeingData['seeing_trans'].push(parseFloat(fields[1]));
                    seeingData['seeing_long'].push(parseFloat(fields[2]));
                    seeingData['star'].push(fields[3]);
                    seeingData['airmass'].push(parseFloat(fields[4]));
                }

                //for (var i in seeingData['dates']) {
                //    console.log(seeingData['dates'][i] + " : " + seeingData['seeing_trans'][i] + " " + seeingData['seeing_long'][i] + " " + seeingData['star'][i] + ' ' + seeingData['airmass'][i]);
                //}
                console.log("Data loaded... " + seeingData['dates'].length + " data points.");
                document.getElementById('npoints').innerText = seeingData['dates'].length;
                if (seeingData['dates'].length) {
                    allCharts=[];
                    allCharts.push(drawSeeingChart());
                    allCharts.push(drawStarChart());
                    allCharts.push(drawAirmassSeeingChart());
                    allCharts.push(drawStatsChart());
                } else {
                    // No data returned... clear the charts
                    for (var i in allCharts) allCharts[i].clearChart();
                }

                latestReading = {};
                var keys = Object.keys(seeingData);
                var lastIndex = seeingData['dates'].length - 1;
                for (var k in keys) {
                    console.log(keys[k]);
                    latestReading[keys[k]] = seeingData[keys[k]][lastIndex];
                }
                if (liveData) updateLiveDisplay();
                // Change the status of the downloading icon back to gray
                $('#downloading').css('color', 'gray');

            }

            function drawStarChart() {
                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn({ type: 'string', id: 'Star' });
                dataTable.addColumn({ type: 'date', id: 'Start' });
                dataTable.addColumn({ type: 'date', id: 'End' });
    
                currentStar = "none";
                for (var i in seeingData['dates']) {
                    if (seeingData['star'][i] != currentStar) {
                        if (currentStar!="none") dataTable.addRow( [ currentStar, startTime, endTime ]);
                        currentStar = seeingData['star'][i];
                        startTime = seeingData['dates'][i];
                    }
                    endTime = seeingData['dates'][i];
                }
                dataTable.addRow( [ currentStar, startTime, endTime ]);
                var chart = new google.visualization.Timeline(document.getElementById('stars'));
                var options = {
                    animation: {startup: true, duration: 750, easing: 'out' } , 
                    backgroundColor: "#f5f4f0", 
                    hAxis: {
                        maxValue: endTime, 
                        minValue: startTime
                        },
                    width: 640,
                   
                };
                chart.draw(dataTable, options);
                return chart;

            }

            function drawAirmassSeeingChart() {
                var data =  new google.visualization.DataTable();
                data.addColumn('number', 'airmass');
                data.addColumn('number', 'seeing');
                for (var i in seeingData['dates']) {
                    meanSeeing = (seeingData['seeing_trans'][i] + seeingData['seeing_long'][i]) / 2;
                    airmass = parseFloat(seeingData['airmass'][i]);
                    data.addRow([airmass, meanSeeing]);
                }
                var chart = new google.visualization.ScatterChart(document.getElementById('airmass'));
                var options = {
                    title: 'Airmass vs Seeing', 
                    hAxis: {title: 'airmass',
                            titleTextStyle: { italic: false }
                            },
                    vAxis: {title: 'seeing (arcsec)',
                            titleTextStyle: { italic: false }
                            },
                    backgroundColor: "#f5f4f0", 
                    series: {
                        0: { pointShape: 'square',
                        visibleInLegend: false },
                    },
                    dataOpacity: 0.4,
                    trendlines: {
                        0: {
                        type: 'linear',
                        color: 'blue',
                        lineWidth: 1,
                        opacity: 0.3,
                        visibleInLegend: false
                        }
                    }
                    
                }
                chart.draw(data, options);
                return chart;
            }

            function drawSeeingChart() {
                var data =  new google.visualization.DataTable();
                data.addColumn('date', 'Date');
                data.addColumn('number', 'Seeing Long');
                data.addColumn('number', 'Seeing Trans');
                for (var i in seeingData['dates']) {
                    data.addRow([seeingData['dates'][i], parseFloat(seeingData['seeing_trans'][i]), parseFloat(seeingData['seeing_long'][i])]);
                }
                
                var options = {
                    title: 'Seeing',
                    legend: { position: 'in' }, 
                    dataOpacity: 1.0,
                    vAxis: {
                        title: 'FWHM (arcsec)',
                        titleTextStyle: { italic: false }
                        },
                    hAxis: {
                        title: 'Time',
                        maxValue: endTime, 
                        minValue: startTime,
                        titleTextStyle: { italic: false },
                        format: 'HH:mm',
                        },
                    chartArea: { 
                        backgroundColor: "#f5f4f0", 
                        width: 600,
                        }, 
                    backgroundColor: "#f5f4f0", 
                    series: {
                        0: { pointShape: 'square' },
                        1: { pointShape: 'triangle' },
                    },
                    explorer: { 
                        actions: ['dragToZoom', 'rightClickToReset'],
                        maxZoomIn: 0.01 
                        },
                };
                if ((endTime - startTime) > 86400*1000) options.hAxis.format = "yyyy-MM-dd";

                var chart = new google.visualization.ScatterChart(document.getElementById('seeing'));
                
                chart.draw(data, options);
                return chart;
            }

            function drawStatsChart() {
                seeing = [];
                for (var i in seeingData['dates']) seeing.push((seeingData['seeing_trans'][i] + seeingData['seeing_long'][i])/2 );
                
                var n = seeing.length;
                var sum = 0;
                for (var i in seeing) sum = sum + seeing[i];
                var mean = sum/n;
                var variance = 0;
                for (var i in seeing) variance+= (seeing[i] - mean)**2;
                var std = Math.sqrt(variance/(n-1));
                console.log("Mean: " + mean);
                console.log("Std deviation: " + std);
                seeing.sort(function(a,b){ return a-b; });
                var midpoint = Math.floor(n / 2);
                if (n % 2) median = seeing[midpoint]; else var median = (seeing[midpoint - 1] + seeing[midpoint]) / 2.0;
                console.log("Median: " + median);

                data =  new google.visualization.DataTable();
                data.addColumn('number', 'Seeing');
                options = {
                    backgroundColor: "#f5f4f0", 
                    title: "median: " + decimalPlacesFloat(median, 2) + " mean: " + decimalPlacesFloat(mean, 2) + " stddev: " + decimalPlacesFloat(std, 2), 
                    hAxis: {title: 'seeing (arcsec)',
                            titleTextStyle: { italic: false }
                            },
                    vAxis: {title: 'N',
                            titleTextStyle: { italic: false }
                            },
                    legend: {position: 'none'},
                    histogram: { hideBucketItems: true }
                    };
                for (var i in seeing) data.addRow([seeing[i]]);
                chart = new google.visualization.Histogram(document.getElementById('stats'));
                chart.draw(data, options);
                return chart;
            }

            function getData(url, callback) {
                var xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    xhr.responseType = 'text';
                    xhr.onload = function() {
                        var status = xhr.status;
                        if (status === 200) {   
                            callback(null, xhr.response);
                        } else {
                            callback(status, xhr.response);
                        }
                    };   
                xhr.send();
            };

            function getNewData(seconds) {
                console.log("in get new data....");
                console.log("getNewData(" + seconds + ")");
                var oldRefresh = dataRefreshSize;
                dataRefreshSize = seconds;
                if (dataRefreshSize > 86400 && liveData ){
                    toggleRefresh();
                    $('#refresh').bootstrapToggle('off');
                }
                document.getElementById("r" + oldRefresh).setAttribute("class", "timebutton");
                document.getElementById("r" + seconds).setAttribute("class", "timebutton btn-primary");
                localStorage.setItem("dataRefreshSize", seconds);
                var now = new Date();
                console.log(now);
                var startDate = new Date(now - seconds * 1000);
                console.log(startDate);
                startTime = startDate;
                endTime = now;
                fillDateFields();
                var params = "time_start=" + encodeURIComponent(formatUTCTime(startTime));
                params+="&time_end=" + encodeURIComponent(formatUTCTime(endTime));
                console.log("Params: " + params);
                // params = "time_start=2018-12-11+20%3A00%3A00";
                //document.getElementById("downloading").setAttribute("style", "colour: green");
                $('#downloading').css('color', 'green');
                getData('http://robodimm.ing.iac.es/robodimm/get_data.php?' + params, processData);
            }    

            function clockTicker() {
		    	var now = new Date();
                // console.log("tick");
			    document.getElementById('UTCfield').value = formatUTCTime(now);
            }

            function fillDateFields() {
                document.getElementById('starttime').value = formatUTCTime(startTime);
                document.getElementById('endtime').value = formatUTCTime(endTime);
            }

            function zeroPad(input) {
                if (input < 10) return "0" + input.toString();
                return input.toString();
            } 

    		function formatUTCTime(date) {
                var dateStr = date.getUTCFullYear() + "-" + zeroPad(date.getUTCMonth()+1) + "-" + zeroPad(date.getUTCDate());
                var time = zeroPad(date.getUTCHours()) + ":" + zeroPad(date.getUTCMinutes()) + ":" + zeroPad(date.getUTCSeconds());
                return dateStr + " " + time;
			}

            function changeDateRange() {
                function isValidDate(d) {
                    return d instanceof Date && !isNaN(d);
                    }
                var newStartTime = document.getElementById('starttime').value;
                var newEndTime = document.getElementById('endtime').value;
                var newStart = new Date(newStartTime);
                var newEnd = new Date(newEndTime);
                if (!isValidDate(newStart)) { alert("Invalid date!"); return; }
                if (!isValidDate(newEnd)) { alert("Invalid date!"); return; }
                if (newEnd<newStart) { alert("end before beginning!"); return }

                startTime = newStart;
                endTime = newEnd;
                console.log("Fetching data from " + formatUTCTime(startTime) + " to " + formatUTCTime(endTime));

                var params = "time_start=" + encodeURIComponent(formatUTCTime(startTime));
                params+="&time_end=" + encodeURIComponent(formatUTCTime(endTime));
                console.log("Params: " + params);
                $('#downloading').css('color', 'green');
                getData('http://robodimm.ing.iac.es/robodimm/get_data.php?' + params, processData);
            }

            function refreshData() {
                getNewData(dataRefreshSize);
            }

            function updateLiveDisplay() {
                console.log(latestReading);
                seeing = (latestReading['seeing_long'] + latestReading['seeing_trans']) /2;
                $('#latestseeing').text(decimalPlacesFloat(seeing, 2)+'"');
                if (seeing<=1.5) document.getElementById("latestseeing").className = "btn-lg btn-success";
                else if ((seeing>1.5) && (seeing<2)) document.getElementById("latestseeing").className = "btn-lg btn-warning";
                else document.getElementById("latestseeing").className = "btn-lg btn-danger";
                $('#lateststar').text(latestReading['star']);
                var timeSince = (new Date() - latestReading['dates']) / 1000;
                console.log("time since " + timeSince);
                var timeSinceStr = "";
                if (timeSince<60) timeSinceStr = decimalPlacesFloat(timeSince, 0) + "s";
                if ((timeSince>=60) && (timeSince<3600)) timeSinceStr = decimalPlacesFloat(timeSince/60, 0) + "m";
                if ((timeSince>=3600) && (timeSince<86400)) {
                    var hours = Math.floor(timeSince/3600);
                    var minutes = Math.floor(timeSince - hours * 60);
                    timeSinceStr = zeroPad(hours) + ":" + zeroPad(minutes);
                }
                if (timeSince>86400) timeSinceStr = ">24hr";
                $('#timesince').text(timeSinceStr);
                
            }
  
            function toggleRefresh(value) {
                if (value) {
                    console.log("Toggle refresh: ON");
                    refreshID = setInterval(refreshData, 30 * 1000);
                    liveData = 1;
                    localStorage.setItem("liveData", 1);
                    document.getElementById("liveDisplay").style.visibility = "visible";
                    getNewData(dataRefreshSize);
                } else {
                    console.log("Toggle refresh: OFF");
                    clearInterval(refreshID);
                    liveData = 0;
                    localStorage.setItem("liveData", 0);
                    document.getElementById("liveDisplay").style.visibility = "hidden";
                }
                
            }
	
            
           
</script>
</head>

<body>
    
    <img src="r2d2graphs.png">
    <div>
        <span class="glyphicon glyphicon-time" style="color:black"></span>
        <input type="text" id="UTCfield" size="21"></input>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span class="glyphicon glyphicon-time" style="color:green"></span>
	    <input type="text" size="21" id="starttime" value="" onchange="changeDateRange()"></input>
        <input type="text" size="21" id="endtime" value="" onchange="changeDateRange()"></input>
        <span class="glyphicon glyphicon-time" style="color:red"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span id="downloading" class="glyphicon glyphicon-download" style="color:gray"></span>
        <input id="refresh" type="checkbox" data-toggle="toggle" data-onstyle="success" data-size="small" data-on="live" data-off="static" onchange="toggleRefresh(this.checked)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <span id="npoints" style="font-weight: bold;">0</span> points in dataset.    
    </div>
    
    <div id="liveDisplay" style="position: absolute; z-index: 1; left: 200px; top: 170px; opacity: 1.0; visibility: hidden;">
        <button class="btn-lg" id="latestseeing" aria-pressed="true" >--</button>
        <button class="btn" id="lateststar" >--</button>
        <button class="btn" id="timesince" >--</button>
    </div>  
    
    <div>
        <button class="timebutton" id="r7200"  onclick="getNewData('7200')">2hr</button>
        <button class="timebutton" id="r14400"   onclick="getNewData('14400')">4hr</button>
        <button class="timebutton" id="r28800"   onclick="getNewData('28800')">8hr</button>
        <button class="timebutton" id="r43200"   onclick="getNewData('43200')">12hr</button>
        <button class="timebutton" id="r86400"   onclick="getNewData('86400')">24hr</button>
        <button class="timebutton" id="r604800"  onclick="getNewData('604800')">1 week</button>
        <button class="timebutton" id="r2678400" onclick="getNewData('2678400')">1 month</button>
        <button class="timebutton" id="r16070400" onclick="getNewData('16070400')">6 months</button>
        <button class="timebutton" id="r31536000" onclick="getNewData('31536000')">1 year</button>
    </div> 

    
    <div id="seeing" style="width: 750px; height: 500px; position: absolute; top: 180px; left: 40px;"></div>
    <div id="stats" style="width: 500px; height: 500px;  position: absolute; top: 180px; left: 750px;"></div>
    <div id="stars" style="width: 720px; height: 400px; position: absolute; top: 700px; left: 0px;"></div>
    <div id="airmass" style="width: 500px; height: 500px;  position: absolute; top: 660px; left: 750px;"></div>
    
</body>
</html>
